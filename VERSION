# Keekar's Parental Control Package Version History
# Format: MAJOR.MINOR.PATCH (two digits each)
# Auto-increment PATCH on each .inc file update

CURRENT_VERSION=0.3.1
BUILD_DATE=2025-12-26
AUTHOR=Mukesh Kesharwani

# Version History:
# 0.3.1 - 2025-12-26 - CRITICAL HOTFIX: Fixed XML syntax error in schedules that caused page failure
# 0.3.0 - 2025-12-26 - Multi-profile schedule support with dynamic dropdown and full API integration
# 0.2.9 - 2025-12-26 - Fixed schedule display and enforcement - list view, status page, and blocking now work
# 0.2.8 - 2025-12-26 - Fixed AQM flowset busy errors - reduced cron frequency and removed excessive filter reloads
# 0.2.7 - 2025-12-26 - CRITICAL: Fixed data loss issue when editing profiles
# 0.2.6 - 2025-12-26 - Separated schedules into dedicated KACI-PC-Schedule tab - fixes +Add button conflict
# 0.2.5 - 2025-12-26 - Fixed +Add button adding schedule fields instead of device fields
# 0.2.4 - 2025-12-26 - BUGFIX: Fixed +Add button in Profiles page not adding device rows
# 0.2.3 - 2025-12-26 - CRITICAL HOTFIXES: Config corruption fixed, Profiles page functional
#                    - CRITICAL: Fixed config.xml corruption (was restoring from backup every minute)
#                    - CRITICAL: Removed duplicate 'devices' key that invalidated XML structure
#                    - CRITICAL: Fixed device selection in Profiles page (JavaScript value mismatch)
#                    - FEATURE: Added IP Address column to Status page for transparency
#                    - FEATURE: Days field now multi-select dropdown (Sun, Mon, Tue, etc)
#                    - FEATURE: Time format examples (24-hour: 08:00=8am, 22:00=10pm)
#                    - BUGFIX: Validation no longer modifies $post (prevents corruption)
#                    - BUGFIX: Cleaned empty device entries from profiles
#                    - RESULT: Profiles can now be saved without corruption
#                    - RESULT: Device selection from dropdown now works correctly
# 0.2.2 - 2025-12-26 - CRITICAL HOTFIXES: Device tracking now works correctly
#                    - BUGFIX: pc_get_devices() now extracts devices from profiles (not separate section)
#                    - BUGFIX: Added 'enable' key to devices so tracking code can detect enabled devices
#                    - BUGFIX: Normalize 'row' to 'devices' for pfSense rowhelper compatibility
#                    - RESULT: Usage tracking and time counters now work correctly
#                    - All 3 bugs that prevented tracking from working are now fixed
#                    - Tested and verified on production system (fw.keekar.com)
# 0.2.1 - 2025-12-26 - CRITICAL FIX: Layer 3 compliance (IP-based architecture)
#                    - CRITICAL: Complete rewrite to use IP addresses for operational logic
#                    -      pfSense operates at Layer 3 (IP layer), not Layer 2 (MAC layer)
#                    -      MAC addresses now only used for device identification in config
#                    -      All tracking, blocking, and firewall rules now use IP addresses
#                    - NEW: devices_by_ip state structure (was devices by MAC)
#                    - NEW: mac_to_ip_cache for fast MAC → IP resolution
#                    - NEW: Automatic state migration from v0.2.0 MAC-based to IP-based
#                    - NEW: IP change detection and handling (DHCP renewals)
#                    - NEW: State migration preserves all usage data during upgrade
#                    - IMPROVED: Analyzer shows IP addresses with MAC references
#                    - IMPROVED: Logs include both IP and MAC for clarity
#                    - ARCHITECTURE: Now properly Layer 3 compliant (firewall-native)
#                    - FIXES: Blocking will now actually work (uses IP not MAC)
#                    - FIXES: Firewall rules will work correctly at L3
#                    - Based on user feedback identifying fundamental Layer 2/3 confusion
# 0.2.0 - 2025-12-26 - MAJOR OVERHAUL: Real connection tracking and architecture improvements
#                    - CRITICAL FIX: Replaced ARP-based tracking with pfctl state table queries
#                    -      Now tracks ACTUAL internet usage instead of just network presence
#                    -      Devices with no active connections don't increment usage
#                    - NEW: PID lock mechanism prevents concurrent cron executions
#                    -      Prevents race conditions and database corruption
#                    - NEW: IP address lookup from MAC address with caching
#                    - IMPROVED: Proper interval calculation (matches cron interval)
#                    - IMPROVED: Enhanced logging with connection counts and execution time
#                    - NEW: Log analyzer tool (parental_control_analyzer.sh)
#                    -      Commands: stats, logs, recent, device, errors, watch, state, status
#                    -      Color-coded output, real-time monitoring, device-specific queries
#                    - PERFORMANCE: Connection tracking uses timeout to prevent hanging
#                    - RELIABILITY: Graceful degradation if state table query fails
#                    - ARCHITECTURE: State file path changed to .jsonl (JSONL format preparation)
#                    - DIAGNOSTICS: Shows connection counts in state file
#                    - Based on insights from MultiServiceLimiter (proven working implementation)
# 0.1.4-hotfix2 - 2025-12-25 - CRITICAL HOTFIX: Fixed logging and usage tracking issues
#                    - BUGFIX: Logging now enabled by default (opt-out instead of opt-in)
#                    - BUGFIX: Log directory automatically created if missing
#                    - BUGFIX: State directory automatically created if missing
#                    - BUGFIX: Graceful degradation - critical messages fallback to syslog if file logging fails
#                    - BUGFIX: File write operations now have error handling with syslog fallback
#                    - FEATURE: Added comprehensive diagnostic script (parental_control_diagnostic.php)
#                    - DOCS: Added detailed troubleshooting guide (TROUBLESHOOTING_USAGE_AND_LOGS.md)
#                    - Diagnostic script checks: service status, logging, log file, state file, cron job,
#                      cron script, devices, firewall rules, PHP version, and performs live tests
# 0.1.4 - 2025-12-25 - MAJOR UPDATE: DRY refactoring, performance optimization, and REST API
#                    - DRY: Added reusable helper functions (pc_normalize_mac, pc_validate_mac,
#                    -      pc_validate_time, pc_validate_numeric_range, pc_is_mac_unique,
#                    -      pc_is_service_enabled, pc_is_device_enabled, pc_get_devices, pc_get_profiles)
#                    - PERFORMANCE: Implemented caching system for expensive operations
#                    -      (DHCP leases, ARP lookups, config reads, state file)
#                    -      Cache TTL: 30 seconds for config, 5 seconds for state
#                    -      Automatic cache invalidation on config/state changes
#                    - API: Full RESTful API with authentication (parental_control_api.php)
#                    -      Endpoints: /devices, /profiles, /usage, /status, /override, /block, /unblock
#                    -      API key authentication via X-API-Key header or query parameter
#                    -      CORS support for external dashboards and mobile apps
#                    -      Comprehensive API documentation (docs/API.md)
#                    - BUGFIX: Fixed PHP parse error from cron syntax in JSDoc (*/1 -> * /1)
#                    - CODE QUALITY: Eliminated code duplication across 20+ locations
#                    - MAINTAINABILITY: Centralized validation and config access logic
# 0.1.3 - 2025-12-25 - ENHANCEMENTS: Added health check endpoint, log rotation,
#                    - JSDoc documentation, configuration examples, quick start guide,
#                    - graceful degradation, try-catch blocks, inline comments,
#                    - DRY refactoring, performance optimizations, environment vars,
#                    - console logging enhancements, and BUILD_INFO tracking
# 0.1.2 - 2025-12-24 - Version sync across files
# 0.1.1 - 2025-12-24 - Bug fixes and improvements
# 0.1.0 - 2025-12-24 - MAJOR FIX: Backend parsing of device_selector dropdown
#                    - Devices now save correctly even without JavaScript
#                    - Auto-fills mac_address, ip_address, device_name from dropdown
#                    - Fixed profile XML configpath and package name
# 0.0.7 - 2025-12-24 - CRITICAL FIX: Correct config path to /config/0/enable
#                    - Service enable status now works correctly
#                    - Fixed all config_path_enabled() calls
# 0.0.6 - 2025-12-24 - Fixed DHCP/ARP device auto-discovery
#                    - Rewrote pc_get_dhcp_leases() to use ARP table directly
#                    - Updated JavaScript to vanilla JS (no jQuery dependency)
#                    - Added console logging for debugging
# 0.0.5 - 2025-12-24 - FINAL FIX: Correct config path (no [0] element)
# 0.0.4 - 2025-12-24 - Added debug logging to find correct path
# 0.0.3 - 2025-12-24 - CRITICAL FIX: Service enable/disable now works correctly
#                    - Fixed config path checking in all functions
#                    - Added configpath to XML for proper pfSense integration
# 0.0.2 - 2025-12-24 - Added DHCP/ARP device auto-discovery dropdown
#                    - Auto-populate device info from network
#                    - Fixed shell syntax errors in INSTALL.sh
# 0.0.1 - 2025-12-24 - Initial release with profile-based device grouping
#                    - Shared time accounting across devices
#                    - OpenTelemetry logging
#                    - Weekend bonus time
#                    - Profile-wide schedules

# Version Numbering Guide:
# - MAJOR (00-99): Breaking changes, major features
# - MINOR (00-99): New features, non-breaking changes
# - PATCH (01-99): Bug fixes, .inc file updates
#
# Examples:
# 0.0.1 → 0.0.2 (bug fix in .inc)
# 0.0.99 → 0.1.0 (new feature added)
# 0.99.99 → 1.0.0 (major release)

# Next version will be: 0.0.2 (on next .inc update)

