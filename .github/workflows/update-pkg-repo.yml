name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Build FreeBSD Package"]
    types:
      - completed
    branches:
      - main
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-pkg-repo.yml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy-to-pages:
    name: Deploy Package Repository to GitHub Pages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download package artifacts
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: freebsd-package
          path: ./packages
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download artifacts from latest release (fallback for push events)
        if: github.event_name != 'workflow_run'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest successful build run
          RUN_ID=$(gh api repos/${{ github.repository }}/actions/workflows/build-package.yml/runs \
            --jq '.workflow_runs | map(select(.conclusion == "success")) | first | .id')
          
          if [ -n "$RUN_ID" ]; then
            echo "Downloading artifacts from run $RUN_ID"
            gh run download $RUN_ID -n freebsd-package -D ./packages
          else
            echo "No successful build found, creating empty directory"
            mkdir -p ./packages
          fi
      
      - name: Create repository directory structure
        run: |
          mkdir -p gh-pages/packages/freebsd/FreeBSD:14:amd64/latest
          mkdir -p gh-pages/fingerprints/kaci
          
          # Copy packages
          cp packages/*.pkg gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp packages/*.pkg.asc gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp packages/*.sha256 gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp packages/*.md5 gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          
          # Copy GPG fingerprint
          cp fingerprint.txt gh-pages/fingerprints/kaci/trusted
      
      - name: Generate repository index
        run: |
          cat > gh-pages/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>KACI Parental Control Package Repository</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #2c3e50; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ðŸ”’ KACI Parental Control Package Repository</h1>
    <p>FreeBSD package repository for Keekar's Parental Control system.</p>
    
    <h2>ðŸ“¦ Installation</h2>
    <p>Configure your pfSense system to use this repository:</p>
    <pre><code># Configure repository
mkdir -p /usr/local/etc/pkg/repos
cat > /usr/local/etc/pkg/repos/kaci.conf << 'REPOEOF'
kaci: {
  url: "pkg+https://keekar2022.github.io/KACI-Parental_Control/packages/freebsd/${ABI}",
  mirror_type: "none",
  signature_type: "fingerprints",
  fingerprints: "/usr/local/etc/pkg/fingerprints/kaci",
  enabled: yes,
  priority: 10
}
REPOEOF

# Download and install GPG fingerprint
mkdir -p /usr/local/etc/pkg/fingerprints/kaci
fetch -o /usr/local/etc/pkg/fingerprints/kaci/trusted \
  https://keekar2022.github.io/KACI-Parental_Control/fingerprints/kaci/trusted

# Install package
pkg update
pkg install -y kaci-parental-control</code></pre>
    
    <h2>ðŸ”— Links</h2>
    <ul>
        <li><a href="packages/freebsd/FreeBSD:14:amd64/latest/">Browse Packages</a></li>
        <li><a href="https://github.com/keekar2022/KACI-Parental_Control">Source Code (Private)</a></li>
        <li><a href="https://github.com/keekar2022/KACI-Parental_Control/issues">Support</a></li>
    </ul>
</body>
</html>
EOF
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          force_orphan: true
      
      - name: Summary
        run: |
          echo "âœ… Package repository deployed to GitHub Pages!"
          echo "ðŸ“¦ Packages available at: https://keekar2022.github.io/KACI-Parental_Control/packages/freebsd/FreeBSD:14:amd64/latest/"
