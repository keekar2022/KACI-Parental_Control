name: Build FreeBSD Package

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PACKAGE_NAME: kaci-parental-control

jobs:
  build:
    name: Build FreeBSD .txz Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(grep "^VERSION=" VERSION | cut -d= -f2)
          BUILD_DATE=$(grep "^BUILD_DATE=" VERSION | cut -d= -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"
      
      - name: Update manifest version
        run: |
          sed -i "s/^version = .*/version = \"${{ steps.version.outputs.version }}\"/" pkg-manifest.ucl
          cat pkg-manifest.ucl
      
      - name: Setup FreeBSD VM
        uses: cross-platform-actions/action@v0.25.0
        with:
          operating_system: freebsd
          version: '14.1'
          shell: bash
          run: |
            # Set package name
            PACKAGE_NAME="kaci-parental-control"
            
            # Create package staging directory
            mkdir -p /tmp/pkg-stage
            
            # Create required directories for @dir directives
            mkdir -p /tmp/pkg-stage/var/log
            mkdir -p /tmp/pkg-stage/var/db
            
            # Copy files to staging according to pkg-plist
            while IFS= read -r file; do
              # Skip comments and directives
              if [[ "$file" =~ ^[[:space:]]*# ]] || [[ "$file" =~ ^@ ]]; then
                continue
              fi
              
              # Create parent directory in staging
              mkdir -p "/tmp/pkg-stage/$(dirname "$file")"
              
              # Determine source file
              case "$file" in
                usr/local/pkg/parental_control.inc)
                  cp parental_control.inc "/tmp/pkg-stage/$file"
                  ;;
                usr/local/pkg/parental_control.xml)
                  cp parental_control.xml "/tmp/pkg-stage/$file"
                  ;;
                usr/local/pkg/parental_control_VERSION)
                  cp VERSION "/tmp/pkg-stage/$file"
                  ;;
                usr/local/www/parental_control_*.php)
                  basename="${file##*/}"
                  cp "$basename" "/tmp/pkg-stage/$file"
                  ;;
                usr/local/etc/rc.d/parental_control_captive.sh)
                  cp parental_control_captive.sh "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/bin/auto_update_parental_control.sh)
                  cp auto_update_parental_control.sh "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/bin/parental_control_cron.php)
                  cp parental_control_cron.php "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/share/pfSense-pkg-KACI-Parental_Control/info.xml)
                  cp info.xml "/tmp/pkg-stage/$file"
                  ;;
              esac
            done < pkg-plist
            
            # Create the package
            sudo pkg create \
              -M pkg-manifest.ucl \
              -p pkg-plist \
              -r /tmp/pkg-stage \
              -o /tmp
            
            # Find the created package
            PACKAGE_FILE=$(ls /tmp/${PACKAGE_NAME}-*.pkg)
            echo "Created package: $PACKAGE_FILE"
            
            # Copy to workspace
            cp "$PACKAGE_FILE" .
      
      - name: Sign package with GPG
        if: github.event_name != 'pull_request'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # Import GPG key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          
          # Configure GPG for non-interactive use
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent
          
          # Sign the package
          PACKAGE_FILE=$(ls ${PACKAGE_NAME}-*.pkg)
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
            --pinentry-mode loopback \
            --armor --detach-sign "$PACKAGE_FILE"
          
          echo "Created signature: ${PACKAGE_FILE}.asc"
      
      - name: Generate checksums
        run: |
          PACKAGE_FILE=$(ls ${PACKAGE_NAME}-*.pkg)
          sha256sum "$PACKAGE_FILE" > "${PACKAGE_FILE}.sha256"
          md5sum "$PACKAGE_FILE" > "${PACKAGE_FILE}.md5"
      
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freebsd-package
          path: |
            *.pkg
            *.pkg.asc
            *.sha256
            *.md5
          retention-days: 90
      
      - name: Generate repository metadata with pkg repo
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: cross-platform-actions/action@v0.25.0
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        with:
          operating_system: freebsd
          version: '14.1'
          shell: bash
          run: |
            # Create repository directory structure
            mkdir -p /tmp/repo
            cp *.pkg /tmp/repo/
            cp *.pkg.asc /tmp/repo/ 2>/dev/null || true
            
            # Generate repository metadata using pkg repo with GPG signing
            cd /tmp/repo
            
            # Import GPG key for signing
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import
            
            # Configure GPG for non-interactive use
            mkdir -p ~/.gnupg
            echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
            echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
            gpgconf --kill gpg-agent || true
            
            # Generate signed repository metadata
            echo "$GPG_PASSPHRASE" | sudo pkg repo . "$GPG_PASSPHRASE"
            
            # Create meta file
            echo "version = 2;" > meta
            echo "packing_format = \"txz\";" >> meta
            tar -czf meta.txz meta
            rm meta
            
            # Verify metadata files were created
            ls -la *.txz
            
            # Copy generated metadata back to workspace
            cd /tmp/repo
            cp packagesite.txz /home/runner/work/KACI-Parental_Control/KACI-Parental_Control/ || true
            cp meta.txz /home/runner/work/KACI-Parental_Control/KACI-Parental_Control/ || true
            cp digests.txz /home/runner/work/KACI-Parental_Control/KACI-Parental_Control/ || true
            cp packagesite.pkg.sig /home/runner/work/KACI-Parental_Control/KACI-Parental_Control/ || true
            
            ls -la /home/runner/work/KACI-Parental_Control/KACI-Parental_Control/*.txz || echo "No .txz files found"
            echo "Repository metadata generated"
      
      - name: Prepare GitHub Pages deployment
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        run: |
          # Create directory structure for GitHub Pages
          mkdir -p gh-pages/packages/freebsd/FreeBSD:15:amd64/latest
          
          # Debug: List files before copying
          echo "Files in current directory:"
          ls -la *.pkg *.pkg.asc *.sha256 *.md5 *.txz 2>/dev/null || echo "Some files not found"
          
          # Copy package and metadata files
          cp *.pkg gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/
          cp *.pkg.asc gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/ 2>/dev/null || true
          cp *.sha256 gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/
          cp *.md5 gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/
          cp meta.txz gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/ 2>/dev/null || echo "No meta.txz (optional, pkg will generate)"
          cp packagesite.txz gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/
          cp digests.txz gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/ 2>/dev/null || echo "No digests.txz (optional)"
          
          # Debug: List files after copying
          echo "Files in gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/:"
          ls -la gh-pages/packages/freebsd/FreeBSD:15:amd64/latest/
          
          # Copy GPG fingerprint
          mkdir -p gh-pages/fingerprints
          cp fingerprint.txt gh-pages/fingerprints/
          
          # Create index.html for GitHub Pages root
          cat > gh-pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>KACI Parental Control - Package Repository</title>
            <meta charset="utf-8">
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #2c3e50; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
            </style>
          </head>
          <body>
            <h1>KACI Parental Control - FreeBSD Package Repository</h1>
            <p>Official package repository for KACI Parental Control on pfSense.</p>
            
            <h2>Installation</h2>
            <pre><code># Configure repository
          mkdir -p /usr/local/etc/pkg/repos
          cat > /usr/local/etc/pkg/repos/kaci.conf << 'REPO_EOF'
          kaci: {
            url: "https://keekar2022.github.io/KACI-Parental_Control/packages/freebsd/${ABI}/latest",
            mirror_type: "NONE",
            signature_type: "fingerprints",
            fingerprints: "/usr/local/etc/pkg/fingerprints/kaci",
            enabled: yes,
            priority: 10
          }
          REPO_EOF
          
          # Install GPG fingerprint
          mkdir -p /usr/local/etc/pkg/fingerprints/kaci
          fetch -o /usr/local/etc/pkg/fingerprints/kaci/trusted \
            https://keekar2022.github.io/KACI-Parental_Control/fingerprints/fingerprint.txt
          
          # Install package
          pkg update
          pkg install -y kaci-parental-control</code></pre>
            
            <h2>Links</h2>
            <ul>
              <li><a href="https://github.com/keekar2022/KACI-Parental_Control">GitHub Repository</a></li>
              <li><a href="packages/freebsd/FreeBSD:15:amd64/latest/">Package Directory</a></li>
              <li><a href="fingerprints/fingerprint.txt">GPG Fingerprint</a></li>
            </ul>
          </body>
          </html>
          EOF
          
          echo "GitHub Pages content prepared"
      
      - name: Deploy to GitHub Pages
        if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy package v${{ steps.version.outputs.version }}'
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.pkg
            *.pkg.asc
            *.sha256
            *.md5
          body: |
            # KACI Parental Control v${{ steps.version.outputs.version }}
            
            ## Installation
            
            ```bash
            # Add custom repository
            mkdir -p /usr/local/etc/pkg/repos
            cat > /usr/local/etc/pkg/repos/kaci.conf << 'EOF'
            kaci: {
              url: "https://keekar2022.github.io/KACI-Parental_Control/packages/freebsd/${ABI}/latest",
              mirror_type: "NONE",
              signature_type: "fingerprints",
              fingerprints: "/usr/local/etc/pkg/fingerprints/kaci",
              enabled: yes,
              priority: 10
            }
            EOF
            
            # Install package
            pkg install -y kaci-parental-control
            ```
            
            ## Upgrade from Previous Version
            
            ```bash
            pkg upgrade kaci-parental-control
            ```
            
            ## Changelog
            
            See [BUILD_INFO.json](https://github.com/keekar2022/KACI-Parental_Control/blob/main/BUILD_INFO.json) for detailed changelog.
            
            ---
            
            **Built:** ${{ steps.version.outputs.build_date }}  
            **Commit:** ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
