name: Build FreeBSD Package

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write

env:
  PACKAGE_NAME: kaci-parental-control

jobs:
  build:
    name: Build FreeBSD .txz Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(grep "^VERSION=" VERSION | cut -d= -f2)
          BUILD_DATE=$(grep "^BUILD_DATE=" VERSION | cut -d= -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"
      
      - name: Update manifest version
        run: |
          sed -i "s/^version = .*/version = \"${{ steps.version.outputs.version }}\"/" pkg-manifest.ucl
          cat pkg-manifest.ucl
      
      - name: Setup FreeBSD VM
        uses: cross-platform-actions/action@v0.25.0
        with:
          operating_system: freebsd
          version: '14.1'
          shell: bash
          run: |
            # Set package name
            PACKAGE_NAME="kaci-parental-control"
            
            # Create package staging directory
            mkdir -p /tmp/pkg-stage
            
            # Create required directories for @dir directives
            mkdir -p /tmp/pkg-stage/var/log
            mkdir -p /tmp/pkg-stage/var/db
            
            # Copy files to staging according to pkg-plist
            while IFS= read -r file; do
              # Skip comments and directives
              if [[ "$file" =~ ^[[:space:]]*# ]] || [[ "$file" =~ ^@ ]]; then
                continue
              fi
              
              # Create parent directory in staging
              mkdir -p "/tmp/pkg-stage/$(dirname "$file")"
              
              # Determine source file
              case "$file" in
                usr/local/pkg/parental_control.inc)
                  cp parental_control.inc "/tmp/pkg-stage/$file"
                  ;;
                usr/local/pkg/parental_control.xml)
                  cp parental_control.xml "/tmp/pkg-stage/$file"
                  ;;
                usr/local/pkg/parental_control_VERSION)
                  cp VERSION "/tmp/pkg-stage/$file"
                  ;;
                usr/local/www/parental_control_*.php)
                  basename="${file##*/}"
                  cp "$basename" "/tmp/pkg-stage/$file"
                  ;;
                usr/local/etc/rc.d/parental_control_captive.sh)
                  cp parental_control_captive.sh "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/bin/auto_update_parental_control.sh)
                  cp auto_update_parental_control.sh "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/bin/parental_control_cron.php)
                  cp parental_control_cron.php "/tmp/pkg-stage/$file"
                  chmod +x "/tmp/pkg-stage/$file"
                  ;;
                usr/local/share/pfSense-pkg-KACI-Parental_Control/info.xml)
                  cp info.xml "/tmp/pkg-stage/$file"
                  ;;
              esac
            done < pkg-plist
            
            # Create the package
            sudo pkg create \
              -M pkg-manifest.ucl \
              -p pkg-plist \
              -r /tmp/pkg-stage \
              -o /tmp
            
            # Find the created package
            PACKAGE_FILE=$(ls /tmp/${PACKAGE_NAME}-*.pkg)
            echo "Created package: $PACKAGE_FILE"
            
            # Copy to workspace
            cp "$PACKAGE_FILE" .
      
      - name: Sign package with GPG
        if: github.event_name != 'pull_request'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          # Import GPG key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          
          # Configure GPG for non-interactive use
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent
          
          # Sign the package
          PACKAGE_FILE=$(ls ${PACKAGE_NAME}-*.pkg)
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
            --pinentry-mode loopback \
            --armor --detach-sign "$PACKAGE_FILE"
          
          echo "Created signature: ${PACKAGE_FILE}.asc"
      
      - name: Generate checksums
        run: |
          PACKAGE_FILE=$(ls ${PACKAGE_NAME}-*.pkg)
          sha256sum "$PACKAGE_FILE" > "${PACKAGE_FILE}.sha256"
          md5sum "$PACKAGE_FILE" > "${PACKAGE_FILE}.md5"
      
      - name: Create repository catalog
        run: |
          # Create a minimal pkg repository catalog
          PACKAGE_FILE=$(ls ${PACKAGE_NAME}-*.pkg)
          PKG_NAME="${PACKAGE_NAME}"
          PKG_VERSION=$(echo "$PACKAGE_FILE" | sed -E 's/.*-([0-9]+\.[0-9]+\.[0-9]+)\.pkg/\1/')
          PKG_SIZE=$(stat -c%s "$PACKAGE_FILE")
          PKG_SHA256=$(sha256sum "$PACKAGE_FILE" | awk '{print $1}')
          
          # Create meta.conf for repository
          cat > meta.conf << 'METAEOF'
          version = 2;
          packing_format = "txz";
          manifests = "packagesite.yaml";
          filesite = "filesite.yaml";
          manifests_archive = "packagesite";
          filesite_archive = "filesite";
          METAEOF
          
          # Create packagesite.yaml with single package entry
          cat > packagesite.yaml << PKGEOF
          ${PKG_NAME}-${PKG_VERSION}:
            name: "${PKG_NAME}"
            version: "${PKG_VERSION}"
            origin: "sysutils/kaci-parental-control"
            comment: "Parental control package for pfSense"
            desc: "KACI Parental Control - Time limits and schedule-based internet access control for pfSense"
            www: "https://github.com/keekar2022/KACI-Parental_Control"
            maintainer: "mukesh@keekar.com"
            prefix: "/usr/local"
            sum: "${PKG_SHA256}"
            flatsize: ${PKG_SIZE}
            path: "${PACKAGE_FILE}"
            repopath: "${PACKAGE_FILE}"
            abi: "FreeBSD:14:amd64"
            arch: "freebsd:14:x86:64"
          PKGEOF
          
          # Create the compressed catalog
          tar -czf packagesite.txz packagesite.yaml
          rm packagesite.yaml
          
          # Compress meta.conf
          tar -czf meta.txz meta.conf
          rm meta.conf
          
          echo "Created repository catalog files:"
          ls -lh packagesite.txz meta.txz
      
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freebsd-package
          path: |
            *.pkg
            *.pkg.asc
            *.sha256
            *.md5
            packagesite.txz
            meta.txz
          retention-days: 90
      
      - name: Prepare GitHub Pages deployment
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          mkdir -p gh-pages/packages/freebsd/FreeBSD:14:amd64/latest
          mkdir -p gh-pages/fingerprints/kaci
          
          # Copy packages and signatures
          cp ${PACKAGE_NAME}-*.pkg gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp ${PACKAGE_NAME}-*.pkg.asc gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp ${PACKAGE_NAME}-*.sha256 gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp ${PACKAGE_NAME}-*.md5 gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          
          # Copy repository catalog files
          cp packagesite.txz gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          cp meta.txz gh-pages/packages/freebsd/FreeBSD:14:amd64/latest/
          echo "Copied repository catalog files"
          
          # Copy GPG fingerprint
          cp fingerprint.txt gh-pages/fingerprints/kaci/trusted
          
          # Generate index.html
          cat > gh-pages/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>KACI Parental Control Package Repository</title>
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
                  h1 { color: #2c3e50; }
                  code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
              </style>
          </head>
          <body>
              <h1>ðŸ”’ KACI Parental Control Package Repository</h1>
              <p>FreeBSD package repository for Keekar's Parental Control system.</p>
              
              <h2>ðŸ“¦ Installation</h2>
              <pre><code>pkg install -y kaci-parental-control</code></pre>
              
              <h2>ðŸ”— Links</h2>
              <ul>
                  <li><a href="packages/freebsd/FreeBSD:14:amd64/latest/">Browse Packages</a></li>
                  <li><a href="https://github.com/keekar2022/KACI-Parental_Control">Source Code</a></li>
              </ul>
          </body>
          </html>
          HTMLEOF
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          publish_branch: gh-pages
          force_orphan: true
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.pkg
            *.pkg.asc
            *.sha256
            *.md5
          body: |
            # KACI Parental Control v${{ steps.version.outputs.version }}
            
            ## Installation
            
            ```bash
            # Configure repository
            mkdir -p /usr/local/etc/pkg/repos
            cat > /usr/local/etc/pkg/repos/kaci.conf << 'EOF'
            kaci: {
              url: "https://keekar2022.github.io/KACI-Parental_Control/packages/freebsd/${ABI}/latest",
              mirror_type: "http",
              signature_type: "fingerprints",
              fingerprints: "/usr/local/etc/pkg/fingerprints/kaci",
              enabled: yes,
              priority: 10
            }
            EOF
            
            # Download GPG fingerprint
            mkdir -p /usr/local/etc/pkg/fingerprints/kaci
            fetch -o /usr/local/etc/pkg/fingerprints/kaci/trusted \
              https://keekar2022.github.io/KACI-Parental_Control/fingerprints/kaci/trusted
            
            # Install package
            pkg update
            pkg install -y kaci-parental-control
            ```
            
            ## Upgrade from Previous Version
            
            ```bash
            pkg upgrade kaci-parental-control
            ```
            
            ## Changelog
            
            See [BUILD_INFO.json](https://github.com/keekar2022/KACI-Parental_Control/blob/main/BUILD_INFO.json) for detailed changelog.
            
            ---
            
            **Built:** ${{ steps.version.outputs.build_date }}  
            **Commit:** ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
